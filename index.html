<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elijah Feldman's Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhXrGynZJS10vLoCM9S2Sj_EHS00xkpgc",
            authDomain: "workflow-8db6b.firebaseapp.com",
            projectId: "workflow-8db6b",
            storageBucket: "workflow-8db6b.firebasestorage.app",
            messagingSenderId: "257703670290",
            appId: "1:257703670290:web:9815a0bf809e30dd159ecb",
            measurementId: "G-V2R1JZ64YJ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
    </script>

    <div class="dashboard-container max-w-7xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden">
        <nav class="tabs-nav flex flex-wrap border-b border-gray-200">
            <a href="#tasks" class="tab-button text-sm md:text-base py-3 px-4 md:py-4 md:px-6 text-gray-600 hover:text-blue-500 focus:outline-none whitespace-nowrap" data-tab="tasks">Task Manager</a>
            <a href="#notes" class="tab-button text-sm md:text-base py-3 px-4 md:py-4 md:px-6 text-gray-600 hover:text-blue-500 focus:outline-none whitespace-nowrap" data-tab="notes">Knowledge Base</a>
            <a href="#scheduler" class="tab-button text-sm md:text-base py-3 px-4 md:py-4 md:px-6 text-gray-600 hover:text-blue-500 focus:outline-none whitespace-nowrap" data-tab="scheduler">Daily Scheduler</a>
            <a href="#focus" class="tab-button text-sm md:text-base py-3 px-4 md:py-4 md:px-6 text-gray-600 hover:text-blue-500 focus:outline-none whitespace-nowrap" data-tab="focus">Focus Timer</a>
            <a href="#habits" class="tab-button text-sm md:text-base py-3 px-4 md:py-4 md:px-6 text-gray-600 hover:text-blue-500 focus:outline-none whitespace-nowrap" data-tab="habits">Habit Tracker</a>
            <a href="#links" class="tab-button text-sm md:text-base py-3 px-4 md:py-4 md:px-6 text-gray-600 hover:text-blue-500 focus:outline-none whitespace-nowrap" data-tab="links">Quick Links</a>
            <a href="#auth" class="tab-button text-sm md:text-base py-3 px-4 md:py-4 md:px-6 text-gray-600 hover:text-blue-500 focus:outline-none whitespace-nowrap" data-tab="auth">Authentication</a>
        </nav>
        <div id="user-status-display" class="px-6 py-2 bg-gray-50 border-b border-gray-200 text-right text-sm text-gray-600">
            Guest
        </div>

        <main id="main-content" class="p-4 md:p-8">
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const mainContent = document.getElementById('main-content');
            const tabs = document.querySelectorAll('.tab-button');

            async function loadContent(tabName) {
                try {
                    const response = await fetch(`pages/${tabName}.html`);
                    if (!response.ok) throw new Error(`Page not found: ${tabName}.html`);
                    const content = await response.text();
                    mainContent.innerHTML = content;
                    
                    tabs.forEach(t => t.classList.remove('active', 'text-blue-500', 'border-b-2', 'border-blue-500'));
                    const activeTab = document.querySelector(`.tab-button[data-tab='${tabName}']`);
                    if(activeTab) activeTab.classList.add('active', 'text-blue-500', 'border-b-2', 'border-blue-500');

                    initializeTab(tabName);
                } catch (error) {
                    mainContent.innerHTML = `<p class="text-center text-red-500">Error loading content: ${error.message}</p>`;
                }
            }

            function router() {
                const hash = window.location.hash.substring(1) || 'tasks';
                loadContent(hash);
            }

            window.addEventListener('hashchange', router);
            router(); // Initial load

            async function initializeTab(tabName) {
                const { collection, addDoc, getDocs, query, where, deleteDoc, doc, updateDoc, getDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
                const db = window.firebaseDb;
                const auth = window.firebaseAuth;
                const { onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");

                switch (tabName) {
                    case 'tasks':
                        const taskForm = document.getElementById('task-input-form');
                        const taskInput = document.getElementById('new-task-input');
                        const taskList = document.getElementById('task-list');
                        let tasks = [];

                        async function renderTasks() {
                            if(!taskList) return;
                            taskList.innerHTML = '';
                            const user = auth.currentUser;
                            if (user) {
                                const q = query(collection(db, "tasks"), where("userId", "==", user.uid));
                                const querySnapshot = await getDocs(q);
                                tasks = [];
                                querySnapshot.forEach((doc) => {
                                    tasks.push({ id: doc.id, ...doc.data() });
                                });
                                tasks.sort((a, b) => (a.createdAt?.toDate() || 0) - (b.createdAt?.toDate() || 0));
                                tasks.forEach((task) => {
                                    const li = document.createElement('li');
                                    li.className = `flex items-center p-3 rounded-lg transition-colors hover:bg-gray-50 ${task.completed ? 'bg-green-50' : 'bg-white'}`;
                                    li.innerHTML = `
                                        <input type="checkbox" data-id="${task.id}" class="h-5 w-5 rounded border-gray-300 text-blue-500 focus:ring-blue-400" ${task.completed ? 'checked' : ''}>
                                        <span class="ml-4 flex-grow ${task.completed ? 'line-through text-gray-500' : ''}">${task.text}</span>
                                        <button class="delete-btn text-gray-400 hover:text-red-500 font-bold text-xl" data-id="${task.id}">&times;</button>
                                    `;
                                    taskList.appendChild(li);
                                });
                            } else {
                                taskList.innerHTML = '<p class="text-center text-gray-500">Please sign in to manage your tasks.</p>';
                            }
                        }

                        taskForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const user = auth.currentUser;
                            if (!user) {
                                alert('Please sign in to add tasks.');
                                return;
                            }
                            if (taskInput.value.trim() === '') return;
                            try {
                                await addDoc(collection(db, "tasks"), {
                                    text: taskInput.value.trim(),
                                    completed: false,
                                    userId: user.uid,
                                    createdAt: new Date()
                                });
                                taskInput.value = '';
                                renderTasks();
                            } catch (error) {
                                console.error("Error adding document: ", error);
                            }
                        });

                        taskList.addEventListener('click', async (e) => {
                            const user = auth.currentUser;
                            if (!user) return;

                            if (e.target.matches('input[type="checkbox"]')) {
                                const taskId = e.target.dataset.id;
                                const taskRef = doc(db, "tasks", taskId);
                                try {
                                    await updateDoc(taskRef, { completed: e.target.checked });
                                    renderTasks();
                                } catch (error) {
                                    console.error("Error updating document: ", error);
                                }
                            }
                            if (e.target.matches('.delete-btn')) {
                                const taskId = e.target.dataset.id;
                                if (confirm('Are you sure you want to delete this task?')) {
                                    try {
                                        await deleteDoc(doc(db, "tasks", taskId));
                                        renderTasks();
                                    } catch (error) {
                                        console.error("Error removing document: ", error);
                                    }
                                }
                            }
                        });
                        onAuthStateChanged(auth, renderTasks);
                        renderTasks();
                        break;
                    case 'notes':
                        const notesArea = document.getElementById('notes-area');
                        const notesStatus = document.getElementById('notes-save-status');
                        let saveTimeout;

                        async function loadNotes() {
                            if(!notesArea) return;
                            const user = auth.currentUser;
                            if (user) {
                                const docRef = doc(db, "notes", user.uid);
                                const docSnap = await getDoc(docRef);
                                notesArea.value = docSnap.exists() ? docSnap.data().content : '';
                                notesArea.disabled = false;
                            } else {
                                notesArea.value = 'Please sign in to save your notes.';
                                notesArea.disabled = true;
                            }
                        }

                        notesArea.addEventListener('input', () => {
                            notesStatus.textContent = 'Saving...';
                            clearTimeout(saveTimeout);
                            saveTimeout = setTimeout(async () => {
                                const user = auth.currentUser;
                                if (user) {
                                    await setDoc(doc(db, "notes", user.uid), {
                                        content: notesArea.value,
                                        updatedAt: new Date()
                                    }, { merge: true });
                                    notesStatus.textContent = 'Saved!';
                                    setTimeout(() => notesStatus.textContent = '', 2000);
                                }
                            }, 500);
                        });
                        onAuthStateChanged(auth, loadNotes);
                        loadNotes();
                        break;
                    case 'scheduler':
                        const schedulerGrid = document.querySelector('.schedule-grid');
                        const hours = ['8:00 AM', '9:00 AM', '10:00 AM', '11:00 AM', '12:00 PM', '1:00 PM', '2:00 PM', '3:00 PM', '4:00 PM', '5:00 PM', '6:00 PM', '7:00 PM'];

                        async function renderSchedule() {
                            if(!schedulerGrid) return;
                            schedulerGrid.innerHTML = '';
                            const user = auth.currentUser;
                            let scheduleData = {};

                            if (user) {
                                const docRef = doc(db, "schedules", user.uid);
                                const docSnap = await getDoc(docRef);
                                if (docSnap.exists()) scheduleData = docSnap.data();
                            }

                            hours.forEach(hour => {
                                const eventKey = `event_${hour.replace(/[^a-zA-Z0-9]/g, '_')}`;
                                const savedEvent = scheduleData[eventKey] || '';

                                const timeSlot = document.createElement('div');
                                timeSlot.className = 'time-slot p-3 border-r border-gray-200 font-semibold text-sm text-right';
                                timeSlot.textContent = hour;

                                const eventSlot = document.createElement('div');
                                eventSlot.className = 'event-slot p-3 border-b border-gray-200 focus:bg-yellow-100 focus:outline-none';
                                eventSlot.contentEditable = user ? 'true' : 'false';
                                eventSlot.textContent = savedEvent;
                                eventSlot.dataset.eventKey = eventKey;

                                eventSlot.addEventListener('blur', async () => {
                                    if (user) {
                                        const updatedData = { [eventSlot.dataset.eventKey]: eventSlot.textContent };
                                        await setDoc(doc(db, "schedules", user.uid), updatedData, { merge: true });
                                    }
                                });

                                schedulerGrid.appendChild(timeSlot);
                                schedulerGrid.appendChild(eventSlot);
                            });
                        }
                        onAuthStateChanged(auth, renderSchedule);
                        renderSchedule();
                        break;
                    case 'focus':
                        let timer;
                        let isRunning = false;
                        let time = 25 * 60;
                        let isWorkTime = true;
                        const timerDisplay = document.getElementById('timer-display');
                        const timerStatus = document.getElementById('timer-status');
                        const startBtn = document.getElementById('start-timer-btn');
                        const stopBtn = document.getElementById('stop-timer-btn');
                        const resetBtn = document.getElementById('reset-timer-btn');

                        function updateDisplay() {
                            if(!timerDisplay) return;
                            const minutes = Math.floor(time / 60);
                            const seconds = time % 60;
                            timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                        }

                        function startTimer() {
                            if (isRunning) return;
                            isRunning = true;
                            startBtn.textContent = 'Running...';
                            startBtn.disabled = true;
                            timer = setInterval(() => {
                                time--;
                                updateDisplay();
                                if (time <= 0) {
                                    clearInterval(timer);
                                    isRunning = false;
                                    startBtn.disabled = false;
                                    startBtn.textContent = 'Start';
                                    alert(isWorkTime ? "Time for a break!" : "Time to get back to work!");
                                    isWorkTime = !isWorkTime;
                                    time = isWorkTime ? 25 * 60 : 5 * 60;
                                    timerStatus.textContent = isWorkTime ? "Time to Work!" : "Time for a Break!";
                                    updateDisplay();
                                }
                            }, 1000);
                        }

                        function stopTimer() {
                            clearInterval(timer);
                            isRunning = false;
                            startBtn.disabled = false;
                            startBtn.textContent = 'Start';
                        }

                        function resetTimer() {
                            stopTimer();
                            isWorkTime = true;
                            time = 25 * 60;
                            timerStatus.textContent = "Get back to Work!";
                            updateDisplay();
                        }

                        startBtn.addEventListener('click', startTimer);
                        stopBtn.addEventListener('click', stopTimer);
                        resetBtn.addEventListener('click', resetTimer);
                        updateDisplay();
                        break;
                    case 'habits':
                        const habits = ['Workout', 'Read', 'Relax', 'Commit'];
                        const habitGrid = document.querySelector('.habit-tracker-grid');
                        let habitData = {};

                        async function renderHabits() {
                            if(!habitGrid) return;
                            habitGrid.innerHTML = '';
                            const user = auth.currentUser;
                            if (user) {
                                const docRef = doc(db, "habits", user.uid);
                                const docSnap = await getDoc(docRef);
                                habitData = docSnap.exists() ? docSnap.data() : {};
                            } else {
                                habitData = {};
                            }

                            habits.forEach((habit, habitIndex) => {
                                const habitRow = document.createElement('div');
                                habitRow.className = 'habit-row grid grid-cols-[minmax(120px,1fr)_repeat(7,40px)] items-center gap-2 p-3 bg-gray-50 rounded-lg';
                                const habitName = document.createElement('div');
                                habitName.className = 'habit-name font-medium';
                                habitName.textContent = habit;
                                habitRow.appendChild(habitName);

                                for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                                    const checkbox = document.createElement('input');
                                    checkbox.type = 'checkbox';
                                    checkbox.className = 'habit-checkbox h-6 w-6 justify-self-center rounded border-gray-300 text-blue-500 focus:ring-blue-400';
                                    checkbox.dataset.habit = habitIndex;
                                    checkbox.dataset.day = dayIndex;
                                    if (habitData[habitIndex] && habitData[habitIndex][dayIndex]) {
                                        checkbox.checked = true;
                                    }
                                    checkbox.disabled = !user;
                                    habitRow.appendChild(checkbox);
                                }
                                habitGrid.appendChild(habitRow);
                            });
                        }

                        habitGrid.addEventListener('change', async (e) => {
                            if (e.target.matches('.habit-checkbox')) {
                                const user = auth.currentUser;
                                if (!user) {
                                    alert('Please sign in to track habits.');
                                    e.target.checked = !e.target.checked;
                                    return;
                                }

                                const habitIndex = e.target.dataset.habit;
                                const dayIndex = e.target.dataset.day;
                                if (!habitData[habitIndex]) habitData[habitIndex] = {};
                                habitData[habitIndex][dayIndex] = e.target.checked;

                                try {
                                    await setDoc(doc(db, "habits", user.uid), habitData, { merge: true });
                                } catch (error) {
                                    console.error("Error updating habit: ", error);
                                }
                            }
                        });
                        onAuthStateChanged(auth, renderHabits);
                        renderHabits();
                        break;
                    case 'links':
                        const links = [
                            { title: 'Discord', url: 'https://discord.com/app' },
                            { title: 'GitHub', url: 'https://github.com' },
                            { title: 'Ion', url: 'https://ion.tjhsst.edu'},
                            { title: 'Gitlab', url: 'https://gitlab.tjhsst.edu' },
                            { title: 'To-Do', url: 'https://elijahfeldman7.github.io/to-do-list'},
                            { title: 'Me', url: 'https://elijahfeldman.me'}
                        ];
                        const linksGrid = document.querySelector('.grid');
                        if(linksGrid){
                            links.forEach(link => {
                                const card = document.createElement('a');
                                card.className = 'link-card block p-4 no-underline text-gray-800 bg-gray-50 border border-gray-200 rounded-lg transition transform hover:-translate-y-1 hover:shadow-lg hover:border-blue-400';
                                card.href = link.url;
                                card.target = '_blank';
                                card.innerHTML = `
                                    <div class="font-bold text-lg mb-1">${link.title}</div>
                                    <div class="text-sm text-gray-600 break-all">${link.url}</div>
                                `;
                                linksGrid.appendChild(card);
                            });
                        }
                        break;
                    case 'auth':
                        const { GoogleAuthProvider, signInWithPopup, signOut } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
                        const googleSigninBtn = document.getElementById('google-signin-btn');
                        const authSignoutBtn = document.getElementById('auth-signout-btn');
                        const authStatusDiv = document.getElementById('auth-status');
                        const authFormDiv = document.getElementById('auth-form');
                        const authLogoutDiv = document.getElementById('auth-logout');
                        const userEmailSpan = document.getElementById('user-email');

                        if(googleSigninBtn) {
                            googleSigninBtn.addEventListener('click', async () => {
                                const provider = new GoogleAuthProvider();
                                try {
                                    await signInWithPopup(auth, provider);
                                } catch (error) {
                                    authStatusDiv.textContent = `Error: ${error.message}`;
                                }
                            });
                        }

                        if(authSignoutBtn) {
                            authSignoutBtn.addEventListener('click', async () => {
                                try {
                                    await signOut(auth);
                                } catch (error) {
                                    authStatusDiv.textContent = `Error: ${error.message}`;
                                }
                            });
                        }

                        onAuthStateChanged(auth, (user) => {
                            if(!authFormDiv || !authLogoutDiv) return;
                            if (user) {
                                authFormDiv.style.display = 'none';
                                authLogoutDiv.style.display = 'block';
                                userEmailSpan.textContent = user.email;
                                authStatusDiv.textContent = '';
                            } else {
                                authFormDiv.style.display = 'block';
                                authLogoutDiv.style.display = 'none';
                                userEmailSpan.textContent = '';
                                authStatusDiv.textContent = 'You are not signed in.';
                            }
                        });
                        break;
                }
            }

            const auth = window.firebaseAuth;
            const { onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
            const userStatusDisplay = document.getElementById('user-status-display');

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userStatusDisplay.textContent = `Logged in as: ${user.email}`;
                } else {
                    userStatusDisplay.textContent = 'Guest';
                }
            });
        });
    </script>

</body>
</html>
