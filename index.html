<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elijah Feldman's Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhXrGynZJS10vLoCM9S2Sj_EHS00xkpgc",
            authDomain: "workflow-8db6b.firebaseapp.com",
            projectId: "workflow-8db6b",
            storageBucket: "workflow-8db6b.firebasestorage.app",
            messagingSenderId: "257703670290",
            appId: "1:257703670290:web:9815a0bf809e30dd159ecb",
            measurementId: "G-V2R1JZ64YJ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
    </script>

    <div class="dashboard-container max-w-7xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden">
        <nav class="tabs-nav flex flex-wrap border-b border-gray-200">
            <button class="tab-button active text-sm md:text-base py-3 px-4 md:py-4 md:px-6 text-gray-600 hover:text-blue-500 focus:outline-none whitespace-nowrap" data-tab="tab-tasks">Task Manager</button>
            <button class="tab-button text-sm md:text-base py-3 px-4 md:py-4 md:px-6 text-gray-600 hover:text-blue-500 focus:outline-none whitespace-nowrap" data-tab="tab-notes">Knowledge Base</button>
            <button class="tab-button text-sm md:text-base py-3 px-4 md:py-4 md:px-6 text-gray-600 hover:text-blue-500 focus:outline-none whitespace-nowrap" data-tab="tab-scheduler">Daily Scheduler</button>
            <button class="tab-button text-sm md:text-base py-3 px-4 md:py-4 md:px-6 text-gray-600 hover:text-blue-500 focus:outline-none whitespace-nowrap" data-tab="tab-focus">Focus Timer</button>
            <button class="tab-button text-sm md:text-base py-3 px-4 md:py-4 md:px-6 text-gray-600 hover:text-blue-500 focus:outline-none whitespace-nowrap" data-tab="tab-habits">Habit Tracker</button>
            <button class="tab-button text-sm md:text-base py-3 px-4 md:py-4 md:px-6 text-gray-600 hover:text-blue-500 focus:outline-none whitespace-nowrap" data-tab="tab-links">Quick Links</button>
            <button class="tab-button text-sm md:text-base py-3 px-4 md:py-4 md:px-6 text-gray-600 hover:text-blue-500 focus:outline-none whitespace-nowrap" data-tab="tab-auth">Authentication</button>
        </nav>
        <div id="user-status-display" class="px-6 py-2 bg-gray-50 border-b border-gray-200 text-right text-sm text-gray-600">
            Guest
        </div>

        <main class="tabs-content p-4 md:p-8">
            <div id="tab-tasks" class="tab-panel active">
                <h2 class="text-2xl font-bold mb-6">My Tasks</h2>
                <form id="task-input-form" class="flex gap-3 mb-6">
                    <input type="text" id="new-task-input" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none" placeholder="Add a new task..." required>
                    <button type="submit" class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">Add Task</button>
                </form>
                <ul id="task-list" class="space-y-2"></ul>
            </div>

            <div id="tab-notes" class="tab-panel">
                <h2 class="text-2xl font-bold mb-6">My Notes</h2>
                <textarea id="notes-area" class="w-full h-96 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none" placeholder="Write anything... your notes are saved automatically."></textarea>
                <div class="save-status mt-2 text-sm text-gray-500 italic" id="notes-save-status"></div>
            </div>

            <div id="tab-scheduler" class="tab-panel">
                <h2 class="text-2xl font-bold mb-6">Today's Schedule</h2>
                <div class="schedule-grid grid grid-cols-[auto_1fr] gap-1">
                </div>
            </div>

            <div id="tab-focus" class="tab-panel">
                <h2 class="text-2xl font-bold mb-6">Focus Timer</h2>
                <div class="timer-container text-center p-8 bg-gray-50 rounded-xl">
                    <div id="timer-status" class="text-xl font-semibold mb-4 text-blue-600">Get back to Work!</div>
                    <div id="timer-display" class="text-8xl font-extralight my-4">25:00</div>
                    <div class="timer-controls flex justify-center gap-4">
                        <button id="start-timer-btn" class="w-32 px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600">Start</button>
                        <button id="stop-timer-btn" class="w-32 px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">Stop</button>
                        <button id="reset-timer-btn" class="w-32 px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600">Reset</button>
                    </div>
                </div>
            </div>

            <div id="tab-habits" class="tab-panel">
                <h2 class="text-2xl font-bold mb-6">Habit Tracker</h2>
                <div class="habit-day-labels grid grid-cols-[minmax(120px,1fr)_repeat(7,40px)] gap-2 px-3 font-bold text-center mb-2">
                    <div class="text-left">Habit</div>
                    <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
                </div>
                <div class="habit-tracker-grid space-y-3">
                </div>
            </div>

            <div id="tab-links" class="tab-panel">
                <h2 class="text-2xl font-bold mb-6">Quick Links</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                </div>
            </div>

            <div id="tab-auth" class="tab-panel">
                <h2 class="text-2xl font-bold mb-6">Authentication</h2>
                <div id="auth-status" class="mb-4 text-center font-medium"></div>
                <div id="auth-form" class="text-center">
                    <button id="google-signin-btn" class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600">Sign in with Google</button>
                </div>
                <div id="auth-logout" class="mt-6 text-center" style="display: none;">
                    <p class="mb-4">You are logged in as <span id="user-email" class="font-semibold"></span>.</p>
                    <button id="auth-signout-btn" class="px-6 py-3 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">Sign Out</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const tabs = document.querySelectorAll('.tab-button');
            const panels = document.querySelectorAll('.tab-panel');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active', 'text-blue-500', 'border-b-2', 'border-blue-500'));
                    panels.forEach(p => p.classList.remove('active'));

                    tab.classList.add('active', 'text-blue-500', 'border-b-2', 'border-blue-500');
                    const targetPanel = document.getElementById(tab.dataset.tab);
                    targetPanel.classList.add('active');
                });
            });
            
            // Set active styles for the initially active tab
            const initialActiveTab = document.querySelector('.tab-button.active');
            if(initialActiveTab) {
                initialActiveTab.classList.add('text-blue-500', 'border-b-2', 'border-blue-500');
            }


            const taskForm = document.getElementById('task-input-form');
            const taskInput = document.getElementById('new-task-input');
            const taskList = document.getElementById('task-list');
            let tasks = [];

            const { collection, addDoc, getDocs, query, where, deleteDoc, doc, updateDoc, getDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
            const db = window.firebaseDb;

            async function renderTasks() {
                taskList.innerHTML = '';
                const user = window.firebaseAuth.currentUser;
                if (user) {
                    const q = query(collection(db, "tasks"), where("userId", "==", user.uid));
                    const querySnapshot = await getDocs(q);
                    tasks = [];
                    querySnapshot.forEach((doc) => {
                        tasks.push({ id: doc.id, ...doc.data() });
                    });
                    tasks.sort((a, b) => (a.createdAt?.toDate() || 0) - (b.createdAt?.toDate() || 0));
                    tasks.forEach((task) => {
                        const li = document.createElement('li');
                        li.className = `flex items-center p-3 rounded-lg transition-colors hover:bg-gray-50 ${task.completed ? 'bg-green-50' : 'bg-white'}`;
                        li.innerHTML = `
                            <input type="checkbox" data-id="${task.id}" class="h-5 w-5 rounded border-gray-300 text-blue-500 focus:ring-blue-400" ${task.completed ? 'checked' : ''}>
                            <span class="ml-4 flex-grow ${task.completed ? 'line-through text-gray-500' : ''}">${task.text}</span>
                            <button class="delete-btn text-gray-400 hover:text-red-500 font-bold text-xl" data-id="${task.id}">&times;</button>
                        `;
                        taskList.appendChild(li);
                    });
                } else {
                    taskList.innerHTML = '<p class="text-center text-gray-500">Please sign in to manage your tasks.</p>';
                }
            }

            taskForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = window.firebaseAuth.currentUser;
                if (!user) {
                    alert('Please sign in to add tasks.');
                    return;
                }
                if (taskInput.value.trim() === '') return;
                try {
                    await addDoc(collection(db, "tasks"), {
                        text: taskInput.value.trim(),
                        completed: false,
                        userId: user.uid,
                        createdAt: new Date()
                    });
                    taskInput.value = '';
                    renderTasks();
                } catch (error) {
                    console.error("Error adding document: ", error);
                }
            });

            taskList.addEventListener('click', async (e) => {
                const user = window.firebaseAuth.currentUser;
                if (!user) return;

                if (e.target.matches('input[type="checkbox"]')) {
                    const taskId = e.target.dataset.id;
                    const taskRef = doc(db, "tasks", taskId);
                    try {
                        await updateDoc(taskRef, { completed: e.target.checked });
                        renderTasks();
                    } catch (error) {
                        console.error("Error updating document: ", error);
                    }
                }
                if (e.target.matches('.delete-btn')) {
                    const taskId = e.target.dataset.id;
                    if (confirm('Are you sure you want to delete this task?')) {
                        try {
                            await deleteDoc(doc(db, "tasks", taskId));
                            renderTasks();
                        } catch (error) {
                            console.error("Error removing document: ", error);
                        }
                    }
                }
            });

            const notesArea = document.getElementById('notes-area');
            const notesStatus = document.getElementById('notes-save-status');
            let saveTimeout;

            async function loadNotes() {
                const user = window.firebaseAuth.currentUser;
                if (user) {
                    const docRef = doc(db, "notes", user.uid);
                    const docSnap = await getDoc(docRef);
                    notesArea.value = docSnap.exists() ? docSnap.data().content : '';
                    notesArea.disabled = false;
                } else {
                    notesArea.value = 'Please sign in to save your notes.';
                    notesArea.disabled = true;
                }
            }

            notesArea.addEventListener('input', () => {
                notesStatus.textContent = 'Saving...';
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(async () => {
                    const user = window.firebaseAuth.currentUser;
                    if (user) {
                        await setDoc(doc(db, "notes", user.uid), {
                            content: notesArea.value,
                            updatedAt: new Date()
                        }, { merge: true });
                        notesStatus.textContent = 'Saved!';
                        setTimeout(() => notesStatus.textContent = '', 2000);
                    }
                }, 500);
            });

            const schedulerGrid = document.querySelector('.schedule-grid');
            const hours = ['8:00 AM', '9:00 AM', '10:00 AM', '11:00 AM', '12:00 PM', '1:00 PM', '2:00 PM', '3:00 PM', '4:00 PM', '5:00 PM', '6:00 PM', '7:00 PM'];

            async function renderSchedule() {
                schedulerGrid.innerHTML = '';
                const user = window.firebaseAuth.currentUser;
                let scheduleData = {};

                if (user) {
                    const docRef = doc(db, "schedules", user.uid);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) scheduleData = docSnap.data();
                }

                hours.forEach(hour => {
                    const eventKey = `event_${hour.replace(/[^a-zA-Z0-9]/g, '_')}`;
                    const savedEvent = scheduleData[eventKey] || '';

                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot p-3 border-r border-gray-200 font-semibold text-sm text-right';
                    timeSlot.textContent = hour;

                    const eventSlot = document.createElement('div');
                    eventSlot.className = 'event-slot p-3 border-b border-gray-200 focus:bg-yellow-100 focus:outline-none';
                    eventSlot.contentEditable = user ? 'true' : 'false';
                    eventSlot.textContent = savedEvent;
                    eventSlot.dataset.eventKey = eventKey;

                    eventSlot.addEventListener('blur', async () => {
                        if (user) {
                            const updatedData = { [eventSlot.dataset.eventKey]: eventSlot.textContent };
                            await setDoc(doc(db, "schedules", user.uid), updatedData, { merge: true });
                        }
                    });

                    schedulerGrid.appendChild(timeSlot);
                    schedulerGrid.appendChild(eventSlot);
                });
            }

            let timer;
            let isRunning = false;
            let time = 25 * 60;
            let isWorkTime = true;
            const timerDisplay = document.getElementById('timer-display');
            const timerStatus = document.getElementById('timer-status');
            const startBtn = document.getElementById('start-timer-btn');
            const stopBtn = document.getElementById('stop-timer-btn');
            const resetBtn = document.getElementById('reset-timer-btn');

            function updateDisplay() {
                const minutes = Math.floor(time / 60);
                const seconds = time % 60;
                timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            function startTimer() {
                if (isRunning) return;
                isRunning = true;
                startBtn.textContent = 'Running...';
                startBtn.disabled = true;
                timer = setInterval(() => {
                    time--;
                    updateDisplay();
                    if (time <= 0) {
                        clearInterval(timer);
                        isRunning = false;
                        startBtn.disabled = false;
                        startBtn.textContent = 'Start';
                        alert(isWorkTime ? "Time for a break!" : "Time to get back to work!");
                        isWorkTime = !isWorkTime;
                        time = isWorkTime ? 25 * 60 : 5 * 60;
                        timerStatus.textContent = isWorkTime ? "Time to Work!" : "Time for a Break!";
                        updateDisplay();
                    }
                }, 1000);
            }

            function stopTimer() {
                clearInterval(timer);
                isRunning = false;
                startBtn.disabled = false;
                startBtn.textContent = 'Start';
            }

            function resetTimer() {
                stopTimer();
                isWorkTime = true;
                time = 25 * 60;
                timerStatus.textContent = "Get back to Work!";
                updateDisplay();
            }

            startBtn.addEventListener('click', startTimer);
            stopBtn.addEventListener('click', stopTimer);
            resetBtn.addEventListener('click', resetTimer);

            const habits = ['Workout', 'Read', 'Relax', 'Commit'];
            const habitGrid = document.querySelector('.habit-tracker-grid');
            let habitData = {};

            async function renderHabits() {
                habitGrid.innerHTML = '';
                const user = window.firebaseAuth.currentUser;
                if (user) {
                    const docRef = doc(db, "habits", user.uid);
                    const docSnap = await getDoc(docRef);
                    habitData = docSnap.exists() ? docSnap.data() : {};
                } else {
                    habitData = {};
                }

                habits.forEach((habit, habitIndex) => {
                    const habitRow = document.createElement('div');
                    habitRow.className = 'habit-row grid grid-cols-[minmax(120px,1fr)_repeat(7,40px)] items-center gap-2 p-3 bg-gray-50 rounded-lg';
                    const habitName = document.createElement('div');
                    habitName.className = 'habit-name font-medium';
                    habitName.textContent = habit;
                    habitRow.appendChild(habitName);

                    for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'habit-checkbox h-6 w-6 justify-self-center rounded border-gray-300 text-blue-500 focus:ring-blue-400';
                        checkbox.dataset.habit = habitIndex;
                        checkbox.dataset.day = dayIndex;
                        if (habitData[habitIndex] && habitData[habitIndex][dayIndex]) {
                            checkbox.checked = true;
                        }
                        checkbox.disabled = !user;
                        habitRow.appendChild(checkbox);
                    }
                    habitGrid.appendChild(habitRow);
                });
            }

            habitGrid.addEventListener('change', async (e) => {
                if (e.target.matches('.habit-checkbox')) {
                    const user = window.firebaseAuth.currentUser;
                    if (!user) {
                        alert('Please sign in to track habits.');
                        e.target.checked = !e.target.checked;
                        return;
                    }

                    const habitIndex = e.target.dataset.habit;
                    const dayIndex = e.target.dataset.day;
                    if (!habitData[habitIndex]) habitData[habitIndex] = {};
                    habitData[habitIndex][dayIndex] = e.target.checked;

                    try {
                        await setDoc(doc(db, "habits", user.uid), habitData, { merge: true });
                    } catch (error) {
                        console.error("Error updating habit: ", error);
                    }
                }
            });

            const links = [
                { title: 'Discord', url: 'https://discord.com/app' },
                { title: 'GitHub', url: 'https://github.com' },
                { title: 'Ion', url: 'https://ion.tjhsst.edu'},
                { title: 'Gitlab', url: 'https://gitlab.tjhsst.edu' },
                { title: 'To-Do', url: 'https://elijahfeldman7.github.io/to-do-list'},
                { title: 'Me', url: 'https://elijahfeldman.me'}
            ];
            const linksGrid = document.querySelector('.links-grid');
            links.forEach(link => {
                const card = document.createElement('a');
                card.className = 'link-card block p-4 no-underline text-gray-800 bg-gray-50 border border-gray-200 rounded-lg transition transform hover:-translate-y-1 hover:shadow-lg hover:border-blue-400';
                card.href = link.url;
                card.target = '_blank';
                card.innerHTML = `
                    <div class="font-bold text-lg mb-1">${link.title}</div>
                    <div class="text-sm text-gray-600 break-all">${link.url}</div>
                `;
                linksGrid.appendChild(card);
            });

            const auth = window.firebaseAuth;
            const { onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
            const googleSigninBtn = document.getElementById('google-signin-btn');
            const authSignoutBtn = document.getElementById('auth-signout-btn');
            const authStatusDiv = document.getElementById('auth-status');
            const authFormDiv = document.getElementById('auth-form');
            const authLogoutDiv = document.getElementById('auth-logout');
            const userEmailSpan = document.getElementById('user-email');
            const userStatusDisplay = document.getElementById('user-status-display');

            googleSigninBtn.addEventListener('click', async () => {
                const { GoogleAuthProvider, signInWithPopup } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    authStatusDiv.textContent = `Error: ${error.message}`;
                }
            });

            authSignoutBtn.addEventListener('click', async () => {
                const { signOut } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
                try {
                    await signOut(auth);
                } catch (error) {
                    authStatusDiv.textContent = `Error: ${error.message}`;
                }
            });

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    authFormDiv.style.display = 'none';
                    authLogoutDiv.style.display = 'block';
                    userEmailSpan.textContent = user.email;
                    userStatusDisplay.textContent = `Logged in as: ${user.email}`;
                    authStatusDiv.textContent = '';
                } else {
                    authFormDiv.style.display = 'block';
                    authLogoutDiv.style.display = 'none';
                    userEmailSpan.textContent = '';
                    userStatusDisplay.textContent = 'Guest';
                    authStatusDiv.textContent = 'You are not signed in.';
                }
                renderTasks();
                loadNotes();
                renderSchedule();
                renderHabits();
            });
        });
    </script>

</body>
</html>
